<!DOCTYPE html>
<html>

<!-- TODO: Remove when integrating into Roll20 -->
<head>
<link rel="stylesheet" href="charsheet.css">
</head>

<!-- TODO: remove this tag when integrating as well, as it apparently causes errors with Roll20's API. -->
<body>

<!-- Left sidebar div containing stats and traits -->
<div style="width:175px;position:absolute;">


<!-- TODO: make these not tables. -->
<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Awareness</h4>
	
    <input type="number" name="attr_detection_mod" step="1" value="0"/>
    <button type="action" name="act_detection">Detection</button>
    <br>
    <input type="number" name="attr_intuition_mod" step="1" value="0"/>
    <button type="action" name="act_intuition">Intuition</button>
    <br>
    <input type="number" name="attr_wilderness_mod" step="1" value="0"/>
    <button type="action" name="act_wilderness">Wilderness</button>
</td>
</table>

<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Charisma</h4>
	
    <input type="number" name="attr_convince_mod" step="1" value="0"/>
    <button type="action" name="act_convince">Convince</button>
    <br>
    <input type="number" name="attr_flair_mod" step="1" value="0"/>
    <button type="action" name="act_flair">Flair</button>
    <br>
    <input type="number" name="attr_performance_mod" step="1" value="0"/>
    <button type="action" name="act_performance">Performance</button>
</td>
</table>

<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Coordination</h4>
	
    <input type="number" name="attr_agility_mod" step="1" value="0"/>
    <button type="action" name="act_agility">Agility</button>
    <br>
    <input type="number" name="attr_dexterity_mod" step="1" value="0"/>
    <button type="action" name="act_dexterity">Dexterity</button>
    <br>
    <input type="number" name="attr_stealth_mod" step="1" value="0"/>
    <button type="action" name="act_stealth">Stealth</button>
</td>
</table>

<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Endurance</h4>
	
    <input type="number" name="attr_endure_mod" step="1" value="0"/>
    <button type="action" name="act_endure">Constitution</button>
    <br>
    <input type="number" name="attr_recovery_mod" step="1" value="0"/>
    <button type="action" name="act_recovery">Persistance</button>
    <br>
    <input type="number" name="attr_toughness_mod" step="1" value="0"/>
    <button type="action" name="act_toughness">Toughness</button>
</td>
</table>

<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Intelligence</h4>
	
    <input type="number" name="attr_engineering_mod" step="1" value="0"/>
    <button type="action" name="act_engineering">Engineering</button>
	<br>
    <input type="number" name="attr_knowledge_mod" step="1" value="0"/>
    <button type="action" name="act_knowledge">Knowledge</button>
    <br>
    <input type="number" name="attr_magic_mod" step="1" value="0"/>
    <button type="action" name="act_magic">Magic</button>
</td>
</table>

<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Spirit</h4>
	
    <input type="number" name="attr_resistance_mod" step="1" value="0"/>
    <button type="action" name="act_resistance">Faith</button>
    <br>
    <input type="number" name="attr_restore_mod" step="1" value="0"/>
    <button type="action" name="act_restore">Interaction</button>
    <br>
    <input type="number" name="attr_willpower_mod" step="1" value="0"/>
    <button type="action" name="act_willpower">Willpower</button>
</td>
</table>

<table style="width:165px;margin-bottom:8px;">
<td>
	<h4 style="display:block; margin:0px; margin-bottom:3px; text-align:center">Strength</h4>
	
    <input type="number" name="attr_grip_mod" step="1" value="0"/>
    <button type="action" name="act_grip">Grip</button>
    <br>
    <input type="number" name="attr_physicality_mod" step="1" value="0"/>
    <button type="action" name="act_physicality">Physicality</button>
    <br>
    <input type="number" name="attr_presence_mod" step="1" value="0"/>
    <button type="action" name="act_presence">Presence</button>
</td>
</table>

</div>

<!-- Main div containing everything else -->
<div style="margin-left:175px;">

<div style="width:860px; margin: 0px auto;">
<h1>Fearless Freedom Character Sheet</h1>

<!-- Div puts advantage in the top right where it is easily accessible -->
<table style="float:right; margin-bottom:5px;">
    <tr>
	    <td>
            <h4>Level:</h4>
		</td>
		<td>
            <input type="number" name="attr_level">
	    </td>
		<td>
		    <!-- This controls how many stacks of advantage a player will have whenever they roll the dice -->
            <h4>Advantage:</h4>
		</td>
		<td>
            <input type="number" name="attr_advantage" size="3" step="1" value="0">
	    </td>
	    <td>
		    <!-- TODO: If toggled, this will reset the player's stacks of advantage after each roll -->
	        <h4 class="sheet-template-container" style="display:none;">Hide Roll:</h4>
		</td>
		<td>
	        <input type="checkbox" name="attr_gmroll" value="1" class="sheet-template-container" style="display:none;">
	    </td>
	</tr>
	<tr>
	    <td>
		    <h4>Specialty:</h4>
		</td>
	    <td>
		    <input type="number" style="width:40px;" name="attr_specialty" value="0" readonly="true"/>
		</td>
		<td>
		    <!-- A separate field of keeping track of disadvantage -->
            <h4>Disadvantage:</h4>
		</td>
		<td>
            <input type="number" name="attr_disadvantage" size="3" step="1" value="0">
	    </td>
		<td></td>
		<td></td>
	</tr>
</table>

<br>
<br>

<!-- Section containing information about the character -->
<!-- Warning! Each input field must contain a name or else the information is not stored between sessions -->
<table style="margin: 0px auto;">
    <tr>
        <td>
            <h4>Name:</h4>
        </td>
        <td>
			<!-- TODO: Make the rolls include the character's name if possible -->
            <input type="text" name="attr_character_name" />
        </td>
		
        <td>
            <h4>Alignment:</h4>
        </td>
        <td>
            <input type="text" name="attr_character_alignment" />
        </td>
        
        <td>
            <h4>Player:</h4>
        </td>
        <td>
            <input type="text" name="attr_character_player" />
        </td>
    </tr>
    <tr>
        <td>
            <h4>Species:</h4>
        </td>
        <td>
            <input type="text" name="attr_character_species" />
        </td>
        
        <td>
            <h4>Size:</h4>
        </td>
        <td>
            <input type="text"  name="attr_character_size" />
        </td>
        
        <td>
            <h4>Background:</h4>
        </td>
        <td>
            <input type="text" name="attr_character_background" />
        </td>
    </tr>
</table>
</div>

<br>

<table style="text-align:center;margin:0px auto;">
    <tr>
	    <td style="padding:8px; border:1px grey solid;">
		    <h4>TC</h4>
			<br>
            <input type="number" name="attr_traitcheck" readonly="true"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Hit Dice</h4>
			<br>
            <input type="number" name="attr_healthdice" />
			<br>
            <input type="text" name="attr_healthdice_type" style="width:50px;"/>
		</td>
	    <td style="padding:8px; border:1px grey solid;">
		    <h4>Health</h4>
			<br>
            <input type="number" name="attr_health" />
			<br>
            <input type="number" name="attr_health_max" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Temp HP</h4>
			<br>
            <input type="number" name="attr_temphp" />
			<br>
            <input type="number" name="attr_temphp_max" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Death Stacks</h4>
			<br>
            <input type="number" name="attr_fatigue" />
			<br>
            <input type="number" name="attr_fatigue_max" value="6" readonly="true" style="width:40px"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Nat. Armor</h4>
			<br>
            <input type="number" name="attr_natarmor" />
			<br>
            <input type="number" name="attr_natarmor_max" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Body Armor</h4>
			<br>
            <input type="number" name="attr_bodyarmor" />
			<br>
            <input type="number" name="attr_bodyarmor_max" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Shield</h4>
			<br>
            <input type="number" name="attr_shield" />
			<br>
            <input type="number" name="attr_shield_max" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Concentration</h4>
			<br>
            <input type="number" name="attr_concentration" />
			<br>
            <input type="number" name="attr_concentration_max" readonly="true" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Mana</h4>
			<br>
            <input type="number" name="attr_mana" />
			<br>
            <input type="number" name="attr_mana_max" />
		</td>
		<td style="padding:8px; border:1px grey solid;">
		    <h4>Mana Dice</h4>
			<br>
            <input type="number" name="attr_manadice" />
			<br>
            <input type="text" name="attr_manadice_type" style="width:50px;"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
			<div style="display: table-cell;">
				<input type="number" name="attr_block_mod" step="1" value="0" readonly="true"/>
				<button type="action" name="act_block">Block</button>
				<br>
				<input type="number" name="attr_dodge_mod" step="1" value="0" readonly="true"/>
				<button type="action" name="act_dodge">Dodge</button>
				<br>
				<input type="number" name="attr_parry_mod" step="1" value="0" readonly="true"/>
				<button type="action" name="act_parry">Parry</button>
			</div>
		</td>
	</tr>
</table>

<br>

<table style="text-align:center;margin:0px auto;">
    <tr>
	    <td style="padding:8px; border:1px grey solid;">
            <h4>Walking</h4>
			<br>
			<input type="number" name="attr_walking"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Swimming</h4>
			<br>
			<input type="number" name="attr_swimming"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Flying</h4>
			<br>
			<input type="number" name="attr_flying"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Hovering</h4>
			<br>
			<input type="number" name="attr_hovering"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Burrow</h4>
			<br>
			<input type="number" name="attr_burrow"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Climbing</h4>
			<br>
			<input type="number" name="attr_climbing"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Crawling</h4>
			<br>
			<input type="number" name="attr_crawling"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Long Jump</h4>
			<br>
			<input type="number" name="attr_longjump"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>High Jump</h4>
			<br>
			<input type="number" name="attr_highjump"/>
		</td>
	</tr>
</table>

<br>

<table style="text-align:center;margin:0px auto;">
    <tr>
	    <td style="padding:8px; border:1px grey solid;">
            <h4>Blunt</h4>
			<br>
			<input type="number" name="attr_tolerance1"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Caustic</h4>
			<br>
			<input type="number" name="attr_tolerance2"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Cold</h4>
			<br>
			<input type="number" name="attr_tolerance3"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Death</h4>
			<br>
			<input type="number" name="attr_tolerance4"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Electric</h4>
			<br>
			<input type="number" name="attr_tolerance5"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Heat</h4>
			<br>
			<input type="number" name="attr_tolerance6"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Light</h4>
			<br>
			<input type="number" name="attr_tolerance7"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Misc.</h4>
			<br>
			<input type="number" name="attr_tolerance8"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Poison</h4>
			<br>
			<input type="number" name="attr_tolerance9"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Psychic</h4>
			<br>
			<input type="number" name="attr_tolerance10"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Puncture</h4>
			<br>
			<input type="number" name="attr_tolerance11"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Sharp</h4>
			<br>
			<input type="number" name="attr_tolerance12"/>
		</td>
		<td style="padding:8px; border:1px grey solid;">
            <h4>Sound</h4>
			<br>
			<input type="number" name="attr_tolerance13"/>
		</td>
	</tr>
</table>

<br>

<table style="text-align:center;margin:0px auto;padding:5px;">
    <tr>
	    <td>
		</td>
		<td>
		    <h4>Weapons:</h4>
		</td>
		<td>
		    <h4>Hit Stat:</h4>
		</td>
		<td>
		    <h4>Damage:</h4>
		</td>
		<td>
		    <h4>Crit Dmg.<h4>
		</td>
	<tr>
	<tr>
		<td>
		    <button type="action" name="act_attack1">Attack!</button>
		</td>
	    <td>
		    <input type="text" name="attr_attack1name">
		</td>
		<td>
		    <input type="text" name="attr_attack1_damage"/>
		    <input type="text" name="attr_attack1_damagetypes"/>
		</td>
		<td>
            <input type="number" name="attr_attack1_crit" step="1" value="0"/>
        </td>
        <td>
            <input type="number" name="attr_attack1_fumble" step="1" value="0"/>
        </td>
	</tr>
	
	<tr>
		<td>
		    <button type="action" name="act_attack2">Attack!</button>
		</td>
	    <td>
		    <input type="text" name="attr_attack2name">
		</td>
		<td>
		    <input type="text" name="attr_attack2_damage"/>
		    <input type="text" name="attr_attack2_damagetypes"/>
		</td>
		<td>
            <input type="number" name="attr_attack2_crit" step="1" value="0"/>
        </td>
        <td>
            <input type="number" name="attr_attack2_fumble" step="1" value="0"/>
        </td>
	</tr>
	<tr>
		<td>
		    <button type="action" name="act_attack3">Attack!</button>
		</td>
	    <td>
		    <input type="text" name="attr_attack3name">
		</td>
		<td>
		    <input type="text" name="attr_attack3_damage"/>
		    <input type="text" name="attr_attack3_damagetypes"/>
		</td>
		<td>
            <input type="number" name="attr_attack3_crit" step="1" value="0"/>
        </td>
        <td>
            <input type="number" name="attr_attack3_fumble" step="1" value="0"/>
        </td>
	</tr>
</table>

<br>

<div style="width:45%;text-align:center;display:inline-block;margin-left:3%">
    <h4>Spells</h4><h4>
    <br>
    <textarea style="width:100%;" rows="4" name="attr_spells"></textarea>
    <h4>Equipment<h4>
	<br>
	<textarea style="width:100%;" rows="13" name="attr_equipment"></textarea>
</div>

<div style="width:45%;text-align:center;display:inline-block;margin-left:2%;">
    <h4>Abilities<h4>
	<br>
	<textarea style="width:100%;" rows="18" name="attr_abilities"></textarea>
	<h4>Class Levels<h4>
	<br>
	<textarea style="width:100%;" rows="18" name="attr_classlevels"></textarea>
</div>

<!-- Dirty way of making the background color reach the bottom of the stats sidepane -->
<!-- TODO: fix -->
<br><br><br><br><br><br><br><br><br><br>

<!-- End div for main panel -->
<!-- All HTML code for the character sheet itself is above this. -->
</div>

<!-- Displays roll results in Roll20's chat -->
<!-- Hidden on the character sheet inside Roll20, but displays oddly if this file is loaded as pure .html -->
<!-- TODO: Beautify -->
<rolltemplate class="sheet-rolltemplate-r_template">
    <!-- For some reason, it does not appear that Roll20's StartRoll() function
    is inherently capable of creating GM-only rolls (i.e. rolls that only the GM can see).
    As this was client-requested behaviour, a work-around had to be introduced.
    
    The following is a nasty trick to hide rolls from clients. In essence, if the "hide-rolls"
    button is checked, the roll template will output a roll set to 'display:none;'. 
    In order for the GM to see the roll, they need to set up a third-party browser extension
    (such as Stylus) with the following snippet of CSS:
	
    .sheet-template-container {
        display:block !important;
    }
    
    This will force the rolls to show on the GM's screen and allow them to make "hidden" rolls.
    These rolls are entirely insecure, as not only can any user configure such a browser extension,
    they can also right-click and select "Inspect" to view the roll's result regardless.
    However, as most players will presumably not be inherently aware of these options, security
    on a very small scale will most likely be a non-issue.
    
    As a side-note, this feature has mild quality-of-life issues, as hidden rolls still take up
    space in the chat for all players. -->
    
    <!-- Version of the roll shown to all players -->
    {{#rollTotal() hide 0}}
    <div class="sheet-template-container" style="border-style:groove; padding-left:10px;">
        <h3>{{name}}</h3>
        <div class="sheet-results">
            <!-- If crit success, show crit roll value in green -->
            {{#rollGreater() computed::roll1 roll1}}
                <h4 style="color:#00D300;">{{computed::roll1}}</h4>
                <!-- If an attack, show damage -->
                {{#rollTotal() type1 1}}
                    <h4>Damage = {{damage2}}</h4>
                {{/rollTotal() type1 1}}
            {{/rollGreater() computed::roll1 roll1}}
            <!-- If fumble, show fumble roll value in red -->
            {{#rollLess() computed::roll1 roll1}}
                <h4 style="color:red;">{{computed::roll1}}</h4>
                <!-- If an attack, show damage -->
                {{#rollTotal() type1 1}}
                    <h4>Damage = {{damage3}}</h4>
                {{/rollTotal() type1 1}}
            {{/rollLess() computed::roll1 roll1}}
            <!-- Otherwise, show default roll value -->
            {{#rollTotal() computed::roll1 roll1}}
                <h4>{{roll1}}</h4>
                <!-- If an attack, show damage -->
                {{#rollTotal() type1 1}}
                    <h4>Damage = {{damage1}}</h4>
                {{/rollTotal() type1 1}}
            {{/rollTotal() computed::roll1 roll1}}
            
            <h4>Advantage = {{advan1}}</h4>
            <h4>Stat = {{stat1}}</h4>
            <h4>Specialty = {{spec1}}</h4>
        </div>
    </div>
    {{/rollTotal() hide 0}}
    
    <!-- Version of the roll only shown to players using a third-party application to specifically force it to show -->
    {{#rollTotal() hide 1}}
    <div class="sheet-template-container" style="border-style:groove; padding-left:10px; display:none;">
        <h3>{{name}}</h3>
        <div class="sheet-results">
            <!-- If crit success, show crit roll value in green -->
            {{#rollGreater() computed::roll1 roll1}}
                <h4 style="color:#00D300;">{{computed::roll1}}</h4>
                <!-- If an attack, show damage -->
                {{#rollTotal() type1 1}}
                    <h4>Damage = {{damage2}}</h4>
                {{/rollTotal() type1 1}}
            {{/rollGreater() computed::roll1 roll1}}
            <!-- If fumble, show fumble roll value in red -->
            {{#rollLess() computed::roll1 roll1}}
                <h4 style="color:red;">{{computed::roll1}}</h4>
                <!-- If an attack, show damage -->
                {{#rollTotal() type1 1}}
                    <h4>Damage = {{damage3}}</h4>
                {{/rollTotal() type1 1}}
            {{/rollLess() computed::roll1 roll1}}
            <!-- Otherwise, show default roll value -->
            {{#rollTotal() computed::roll1 roll1}}
                <h4>{{roll1}}</h4>
                <!-- If an attack, show damage -->
                {{#rollTotal() type1 1}}
                    <h4>Damage = {{damage1}}</h4>
                {{/rollTotal() type1 1}}
            {{/rollTotal() computed::roll1 roll1}}
            
            <h4>Advantage = {{advan1}}</h4>
            <h4>Stat = {{stat1}}</h4>
            <h4>Specialty = {{spec1}}</h4>
        </div>
    </div>
    {{/rollTotal() hide 1}}
</rolltemplate>

<script type="text/worker">
    
    //Updates concentration when health is changed or when the sheet is opened
    on("change:health_max sheet:opened", function() {
        getAttrs(["health_max"], function(values) {
            let value = Math.ceil((parseInt(values.health_max)||0)/2)
            setAttrs({
                concentration_max: value
            });
        });
    });
    
    
    
    //Blocks of code to initiate rolls
	//TODO: actually all of this has to be redone
    {
    
    //advRoll arguments:
    //advRoll(type, name, stat, stat2, damage, critdamage, mindamage, spec_bool, spec_bool2)
    //type = "trait" / "attack" / "defense"
    //name = name of roll to put in chat
    //stat = stat to use for roll
    //stat2 = stat to use for damage rolls (if applicable)
    //damage = damage dice
    //critdamage = extra damage on a crit
    //mindamage = minimum damage to do on a fumble
    //spec_bool = specialization bonus for rolling to hit
    //spec_bool2 = TODO: delete
    
    //Trait rolls
    {
    //Awareness
    {
    on('clicked:detection', (info) => {
        getAttrs(["awrmod", "detection_spec"], function(values) {
            advRoll("trait", "Detection", values.awrmod, null, null, null, null, values.detection_spec, null);
        });
    });
    
    on('clicked:intuition', (info) => {
        getAttrs(["awrmod", "intuition_spec"], function(values) {
            advRoll("trait", "Intuition", values.awrmod, null, null, null, null, values.intuition_spec, null);
        });
    });
    
    on('clicked:wilderness', (info) => {
        getAttrs(["awrmod", "wilderness_spec"], function(values) {
            advRoll("trait", "Wilderness", values.awrmod, null, null, null, null, values.wilderness_spec, null);
        });
    });
    }
    //Charisma
    {
    on('clicked:convince', (info) => {
        getAttrs(["chamod", "convince_spec"], function(values) {
            advRoll("trait", "Convince", values.chamod, null, null, null, null, values.convince_spec, null);
        });
    });
    
    on('clicked:flair', (info) => {
        getAttrs(["chamod", "flair_spec"], function(values) {
            advRoll("trait", "Flair", values.chamod, null, null, null, null, values.flair_spec, null);
        });
    });
    
    on('clicked:interaction', (info) => {
        getAttrs(["chamod", "interaction_spec"], function(values) {
            advRoll("trait", "Performance", values.chamod, null, null, null, null, values.interaction_spec, null);
        });
    });
    }
    //Coordination
    {
    on('clicked:agility', (info) => {
        getAttrs(["cormod", "agility_spec"], function(values) {
            advRoll("trait", "Agility", values.cormod, null, null, null, null, values.agility_spec, null);
        });
    });
    
    on('clicked:dexterity', (info) => {
        getAttrs(["cormod", "dexterity_spec"], function(values) {
            advRoll("trait", "Dexterity", values.cormod, null, null, null, null, values.dexterity_spec, null);
        });
    });
    
    on('clicked:stealth', (info) => {
        getAttrs(["cormod", "stealth_spec"], function(values) {
            advRoll("trait", "Stealth", values.cormod, null, null, null, null, values.stealth_spec, null);
        });
    });
    }
    //Intelligence
    {
    on('clicked:knowledge', (info) => {
        getAttrs(["intmod", "knowledge_spec"], function(values) {
            advRoll("trait", "Knowledge", values.intmod, null, null, null, null, values.knowledge_spec, null);
        });
    });
    
    on('clicked:magic', (info) => {
        getAttrs(["intmod", "magic_spec"], function(values) {
            advRoll("trait", "Magic", values.intmod, null, null, null, null, values.magic_spec, null);
        });
    });
    
    on('clicked:medicine', (info) => {
        getAttrs(["intmod", "medicine_spec"], function(values) {
            advRoll("trait", "Medicine", values.intmod, null, null, null, null, values.medicine_spec, null);
        });
    });
    }
    //Strength
    {
    on('clicked:grip', (info) => {
        getAttrs(["strmod", "grip_spec"], function(values) {
            advRoll("trait", "Grip", values.strmod, null, null, null, null, values.grip_spec, null);
        });
    });
    
    on('clicked:physicality', (info) => {
        getAttrs(["strmod", "physicality_spec"], function(values) {
            advRoll("trait", "Physicality", values.strmod, null, null, null, null, values.physicality_spec, null);
        });
    });
    
    on('clicked:presence', (info) => {
        getAttrs(["strmod", "presence_spec"], function(values) {
            advRoll("trait", "Presence", values.strmod, null, null, null, null, values.presence_spec, null);
        });
    });
    }
    //Resolve
    {
    on('clicked:resistance', (info) => {
        getAttrs(["resmod", "resistance_spec"], function(values) {
            advRoll("trait", "Resistance", values.resmod, null, null, null, null, values.resistance_spec, null);
        });
    });
    
    on('clicked:restore', (info) => {
        getAttrs(["resmod", "restore_spec"], function(values) {
            advRoll("trait", "Restore", values.resmod, null, null, null, null, values.restore_spec, null);
        });
    });
    
    on('clicked:willpower', (info) => {
        getAttrs(["resmod", "willpower_spec"], function(values) {
            advRoll("trait", "Willpower", values.resmod, null, null, null, null, values.willpower_spec, null);
        });
    });
    }
    //Withstand
    {
    on('clicked:endure', (info) => {
        getAttrs(["wsdmod", "endure_spec"], function(values) {
            advRoll("trait", "Endure", values.wsdmod, null, null, null, null, values.endure_spec, null);
        });
    });
    
    on('clicked:recovery', (info) => {
        getAttrs(["wsdmod", "recovery_spec"], function(values) {
            advRoll("trait", "Recovery", values.wsdmod, null, null, null, null, values.recovery_spec, null);
        });
    });
    
    on('clicked:toughness', (info) => {
        getAttrs(["wsdmod", "toughness_spec"], function(values) {
            advRoll("trait", "Toughness", values.wsdmod, null, null, null, null, values.toughness_spec, null);
        });
    });
    }
    }
    
    //Attacks
    {
    on('clicked:attack1', (info) => {
        getAttrs(["attack1_hitstat", "attack1_damage", "attack1_crit", "attack1_fumble", "attack1_damstat", "attack1_spec", "awrmod", "chamod", "cormod", "intmod", "strmod", "wsdmod", "resmod"], function(values) {
            let hitmod = 0;
            if(values.attack1_hitstat == "0"){
                hitmod = values.awrmod;
            } else if(values.attack1_hitstat == "1"){
                hitmod = values.chamod;
            } else if(values.attack1_hitstat == "2"){
                hitmod = values.cormod;
            } else if(values.attack1_hitstat == "3"){
                hitmod = values.intmod;
            } else if(values.attack1_hitstat == "4"){
                hitmod = values.strmod;
            } else if(values.attack1_hitstat == "5"){
                hitmod = values.wsdmod;
            }
            else{
                hitmod = values.resmod;
            }
            
            let dammod = 0;
            if(values.attack1_damstat == "0"){
                dammod = values.awrmod;
            } else if(values.attack1_damstat == "1"){
                dammod = values.chamod;
            } else if(values.attack1_damstat == "2"){
                dammod = values.cormod;
            } else if(values.attack1_damstat == "3"){
                dammod = values.intmod;
            } else if(values.attack1_damstat == "4"){
                dammod = values.strmod;
            } else if(values.attack1_damstat == "5"){
                dammod = values.wsdmod;
            }
            else{
                dammod = values.resmod;
            }
            
            advRoll("attack", "Attack", hitmod, dammod, values.attack1_damage, parseInt(values.attack1_crit), parseInt(values.attack1_fumble), values.attack1_spec, values.attack1_spec);
        });
    });
    
    on('clicked:attack2', (info) => {
        getAttrs(["attack2_hitstat", "attack2_damage", "attack2_crit", "attack2_fumble", "attack2_damstat", "attack2_spec", "awrmod", "chamod", "cormod", "intmod", "strmod", "wsdmod", "resmod"], function(values) {
            let hitmod = 0;
            if(values.attack2_hitstat == "0"){
                hitmod = values.awrmod;
            } else if(values.attack2_hitstat == "1"){
                hitmod = values.chamod;
            } else if(values.attack2_hitstat == "2"){
                hitmod = values.cormod;
            } else if(values.attack2_hitstat == "3"){
                hitmod = values.intmod;
            } else if(values.attack2_hitstat == "4"){
                hitmod = values.strmod;
            } else if(values.attack2_hitstat == "5"){
                hitmod = values.wsdmod;
            }
            else{
                hitmod = values.resmod;
            }
            
            let dammod = 0;
            if(values.attack2_hitstat == "0"){
                dammod = values.awrmod;
            } else if(values.attack2_damstat == "1"){
                dammod = values.chamod;
            } else if(values.attack2_damstat == "2"){
                dammod = values.cormod;
            } else if(values.attack2_damstat == "3"){
                dammod = values.intmod;
            } else if(values.attack2_damstat == "4"){
                dammod = values.strmod;
            } else if(values.attack2_damstat == "5"){
                dammod = values.wsdmod;
            }
            else{
                dammod = values.resmod;
            }
            
            advRoll("attack", "Attack", hitmod, dammod, values.attack2_damage, parseInt(values.attack2_crit), parseInt(values.attack2_fumble), values.attack2_spec, values.attack2_spec);
        });
    });
    
    on('clicked:attack3', (info) => {
        getAttrs(["attack3_hitstat", "attack3_damage", "attack3_crit", "attack3_fumble", "attack3_damstat", "attack3_spec", "awrmod", "chamod", "cormod", "intmod", "strmod", "wsdmod", "resmod"], function(values) {
            let hitmod = 0;
            if(values.attack3_hitstat == "0"){
                hitmod = values.awrmod;
            } else if(values.attack3_hitstat == "1"){
                hitmod = values.chamod;
            } else if(values.attack3_hitstat == "2"){
                hitmod = values.cormod;
            } else if(values.attack3_hitstat == "3"){
                hitmod = values.intmod;
            } else if(values.attack3_hitstat == "4"){
                hitmod = values.strmod;
            } else if(values.attack3_hitstat == "5"){
                hitmod = values.wsdmod;
            }
            else{
                hitmod = values.resmod;
            }
            
            let dammod = 0;
            if(values.attack3_hitstat == "0"){
                dammod = values.awrmod;
            } else if(values.attack3_damstat == "1"){
                dammod = values.chamod;
            } else if(values.attack3_damstat == "2"){
                dammod = values.cormod;
            } else if(values.attack3_damstat == "3"){
                dammod = values.intmod;
            } else if(values.attack3_damstat == "4"){
                dammod = values.strmod;
            } else if(values.attack3_damstat == "5"){
                dammod = values.wsdmod;
            }
            else{
                dammod = values.resmod;
            }
            
            advRoll("attack", "Attack", hitmod, dammod, values.attack3_damage, parseInt(values.attack3_crit), parseInt(values.attack3_fumble), values.attack3_spec, values.attack3_spec);
        });
    });
    }
    
    //Defensive actions
    {
    on('clicked:block', (info) => {
        getAttrs(["strmod", "block_spec"], function(values) {
            advRoll("defense", "Block", values.strmod, null, null, null, null, values.block_spec, null);
        });
    });
    
    on('clicked:dodge', (info) => {
        getAttrs(["cormod", "dodge_spec"], function(values) {
            advRoll("defense", "Dodge", values.cormod, null, null, null, null, values.dodge_spec, null);
        });
    });
    
    on('clicked:parry', (info) => {
        getAttrs(["awrmod", "parry_spec"], function(values) {
            advRoll("defense", "Parry", values.awrmod, null, null, null, null, values.parry_spec, null);
        });
    });
    }
    }
    
    
    
    //Function to make a dice roll
	//TODO: const _makeRoll = (type, name, stat, stat2, damage, critdamage, mindamage, spec_bool, spec_bool2) => {
	const _makeRoll = (rollname, rolltype, bonus, rolldice) => {
        getAttrs(["advantage", "gmroll", "character_name"], function(values) {
            //get global values
            let advan = parseInt(values.advantage);
            let hiddenroll = parseInt(values.gmroll);
			let charname = parseInt(values.character_name);
            
			//determine dice roll
            let rolltext = "";
            if(advan >= 0){
                //If player has advantage, take highest
                rolltext = `[[2 + ${advan}]]d10kh2cs>21cf<0 + ${bonus}`
            } else {
                //If player has disadvanatage, take lowest
                //I have no idea why "2 + ${advan} * -1" works, but "2 - ${advan}" doesn't
                rolltext = `[[2 + ${advan} * -1]]d10kl2cs>21cf<0 + ${bonus}`
            }
            
			
			
            let damagetext = "0";
            let crittext = "0";
            let mintext = "0";
            if(type == "attack"){
                damagetext = `${damage} + ${stat2}`
                crittext = `${damage} + ${stat2} + ${critdamage}`
                mintext = `${mindamage}d1 + ${stat2}`
            }
            
            let rolltype = "";
            if(type == "trait" || type == "defense"){
                rolltype = "0"
            }
            else{
                rolltype = "1"
            }
            
			//TODO: old
            //Function to make rolls is part of Roll20's API
            //name      = name of roll
            //type1     = type of roll (attack/trait/defense)
            //advan1    = amount of advantage for the roll
            //stat1     = stat used for roll
            //spec1     = specialization bonus added to roll
            //roll1     = type of dice to roll
            //damage1   = type of dice to roll for damage
            //damage2   = extra damage to add on a crit
            //damage3   = minimum damage to set roll to on a fumble
            //hide1     = whether the roll should be hidden for only the GM to see
			
			//TODO: roll parameters::
			//>Name of roll
			//>Name of roll's instigator
			//>Type of roll (whether should do damage, whether thrown or spellcast, etc.)
			//>Bonus to the roll
			//>Amount of advantage on the roll
			//>Type of dice to roll
			//>Damage required
			//??Extra damage on a crit
			//>Whether the roll should be hidden
			//??Can you decompose rolls? Because if so, then it'd be great to show every roll immediately with advantage
			//??In fact, whether the roll's internals should be shown at all is a legitimate question
            startRoll(`&{template:r_template} {{name=${name}}} {{type1=[[${rolltype}]]}} {{advan1=${advan}}} {{stat1=${stat}}} {{spec1=${spec}}} {{roll1=[[${rolltext}]]}} {{damage1=[[${damagetext}]]}} {{damage2=[[${crittext}]]}} {{damage3=[[${mintext}]]}} {{hide=[[${hiddenroll}d1]]}}`, (results) => {
                let original = results.results.roll1.result
                let computed = original - spec - stat;
                
                //Determines if the number is a crit
                //computed cannot be directly compared to an integer using "==", so comparisons are instead made using ">"
                if(computed > 19){
                    computed  = original * 2;
                }else if(computed < 3) {
                    computed = Math.ceil(original / 2);
                } else {
                    computed = original;
                }

                finishRoll(
                    results.rollId,
                    {
                        roll1: computed
                    }
                );
            });
        });
    }
</script>
